<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Veo 3 Video Generator Client</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom spinner animation */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .spinner {
            display: inline-block;
            width: 1.5rem;
            height: 1.5rem;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: #3b82f6; /* Tailwind blue-500 */
            border-radius: 50%;
            animation: spin 1s ease-in-out infinite;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex items-center justify-center p-4 font-sans">

    <div class="w-full max-w-xl bg-white p-8 rounded-xl shadow-2xl border border-blue-100">
        <h1 class="text-3xl font-extrabold text-gray-800 mb-4 text-center">
            Veo 3 Video Generator
        </h1>
        <p class="text-center text-gray-500 mb-8">
            Enter a prompt and click "Generate" to call your Flask backend.
        </p>

        <form id="videoForm" class="space-y-6">
            <div>
                <label for="prompt" class="block text-sm font-medium text-gray-700 mb-2">
                    Video Prompt (e.g., "A cinematic shot of a drone flying through a dense forest at sunset")
                </label>
                <textarea id="prompt" rows="4" required
                    class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 transition duration-150"
                    placeholder="Describe the video you want Veo 3 to create..."
                ></textarea>
            </div>

            <button type="submit" id="generateButton"
                class="w-full flex justify-center items-center py-3 px-4 border border-transparent 
                       rounded-lg shadow-lg text-lg font-semibold text-white bg-blue-600 
                       hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-500 
                       focus:ring-opacity-50 transition duration-300 transform hover:scale-[1.01] 
                       disabled:bg-blue-400"
                disabled
            >
                <span id="buttonText">Generate Video (Warning: May take minutes)</span>
                <div id="spinner" class="hidden ml-3 spinner"></div>
            </button>
        </form>

        <div id="messageBox" class="mt-6 p-4 rounded-lg text-sm transition-opacity duration-300 hidden">
            <!-- Messages will appear here -->
        </div>

        <p class="mt-8 text-xs text-gray-400 text-center">
            Note: This client assumes your Flask app is running locally at <code class="text-gray-500">http://127.0.0.1:5000</code>.
        </p>
    </div>

    <script>
        const FLASK_ENDPOINT = "https://furygold.pythonanywhere.com/generate_video_veo";
        const form = document.getElementById('videoForm');
        const promptInput = document.getElementById('prompt');
        const generateButton = document.getElementById('generateButton');
        const buttonText = document.getElementById('buttonText');
        const spinner = document.getElementById('spinner');
        const messageBox = document.getElementById('messageBox');

        // Enable button when prompt is not empty
        promptInput.addEventListener('input', () => {
            generateButton.disabled = promptInput.value.trim() === '';
        });

        // Function to display messages
        function showMessage(text, isError = false) {
            messageBox.classList.remove('hidden');
            messageBox.textContent = text;
            if (isError) {
                messageBox.className = 'mt-6 p-4 rounded-lg text-sm bg-red-100 text-red-800 transition-opacity duration-300';
            } else {
                messageBox.className = 'mt-6 p-4 rounded-lg text-sm bg-blue-100 text-blue-800 transition-opacity duration-300';
            }
        }

        // Handle form submission
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            // Setup loading state
            generateButton.disabled = true;
            buttonText.textContent = "Generating... (Polling Backend)";
            spinner.classList.remove('hidden');
            messageBox.classList.add('hidden');

            const prompt = promptInput.value.trim();
            if (!prompt) {
                showMessage("Prompt cannot be empty.", true);
                return;
            }
            
            showMessage("Request sent. The Flask server is now synchronously waiting for the video. This may take a few minutes.", false);

            try {
                const response = await fetch(FLASK_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ prompt: prompt })
                });

                // Check if the response is an error JSON from the server
                if (response.headers.get('content-type')?.includes('application/json') && !response.ok) {
                    const errorData = await response.json();
                    showMessage(`Generation Error (${response.status}): ${errorData.error}`, true);
                    return;
                }

                // Handle successful file download (HTTP 200 OK)
                if (response.ok) {
                    const blob = await response.blob();
                    
                    // Extract filename from headers if possible, otherwise use a default
                    const contentDisposition = response.headers.get('Content-Disposition');
                    let filename = "generated_veo_video.mp4";
                    if (contentDisposition) {
                        const match = contentDisposition.match(/filename="(.+?)"/);
                        if (match) {
                            filename = match[1];
                        }
                    }

                    // Create a link element to trigger the download
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    
                    showMessage(`âœ… Success! Video file "${filename}" started downloading.`, false);
                } else {
                    // Catch other non-JSON HTTP errors
                    showMessage(`Failed to generate video. Server returned status: ${response.status} ${response.statusText}`, true);
                }

            } catch (error) {
                showMessage(`Network Error: Could not connect to Flask server. Please ensure the backend is running at ${FLASK_ENDPOINT} and that CORS is enabled.`, true);
                console.error('Fetch error:', error);
            } finally {
                // Reset UI state
                generateButton.disabled = false;
                buttonText.textContent = "Generate Video (Warning: May take minutes)";
                spinner.classList.add('hidden');
            }
        });
    </script>
</body>
</html>
